<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>محرر مثل CodePen + لوحة تحكم</title>

  <style>
    :root{
      --bg:#0b1220;
      --panel:#0f1a2e;
      --panel2:#101c33;
      --line:#223255;
      --text:#e8eefc;
      --muted:#a9b7dd;
      --accent:#6aa6ff;
      --accent2:#7df0c6;
      --danger:#ff6a6a;
      --warn:#ffd36a;
      --ok:#67ff9e;
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --radius:16px;
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      background:linear-gradient(180deg, var(--bg), #070b14);
      color:var(--text);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      height:100vh;
      overflow:hidden;
    }

    .app{
      display:flex;
      height:100vh;
      width:100%;
    }

    /* لوحة التحكم */
    .control{
      width:340px;
      min-width:300px;
      background:linear-gradient(180deg, var(--panel), var(--panel2));
      border-left:1px solid var(--line);
      padding:16px;
      overflow:auto;
      box-shadow: var(--shadow);
    }

    .brand{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      margin-bottom:14px;
    }
    .brand h1{
      font-size:16px;
      margin:0;
      letter-spacing:.2px;
    }
    .pill{
      font-size:12px;
      color:var(--muted);
      border:1px solid var(--line);
      padding:6px 10px;
      border-radius:999px;
      background:rgba(255,255,255,.03);
    }

    .section{
      border:1px solid var(--line);
      border-radius: var(--radius);
      padding:12px;
      background:rgba(255,255,255,.02);
      margin-bottom:12px;
    }
    .section h2{
      margin:0 0 10px;
      font-size:13px;
      color:var(--muted);
      font-weight:600;
    }

    .grid2{display:grid; grid-template-columns:1fr 1fr; gap:10px;}
    .grid1{display:grid; grid-template-columns:1fr; gap:10px;}

    button, input, select, textarea{
      font:inherit;
      color:var(--text);
      border-radius:12px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.03);
      outline:none;
    }
    input, select, textarea{
      padding:10px 12px;
      width:100%;
    }
    textarea.small{
      min-height:90px;
      resize:vertical;
      line-height:1.4;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      font-size:12.5px;
    }

    button{
      padding:10px 12px;
      cursor:pointer;
      transition:.15s ease;
      font-weight:600;
      user-select:none;
    }
    button:hover{transform:translateY(-1px); border-color:#2c4274; background:rgba(255,255,255,.06);}
    button:active{transform:translateY(0);}

    .btn-primary{border-color:rgba(106,166,255,.5); background:rgba(106,166,255,.12);}
    .btn-danger{border-color:rgba(255,106,106,.5); background:rgba(255,106,106,.10);}
    .btn-warn{border-color:rgba(255,211,106,.55); background:rgba(255,211,106,.10);}
    .btn-ok{border-color:rgba(103,255,158,.45); background:rgba(103,255,158,.10);}

    .hint{
      font-size:12px;
      color:var(--muted);
      line-height:1.5;
      margin:0;
    }

    .snippets{
      display:flex;
      flex-direction:column;
      gap:8px;
    }
    .snippet-item{
      display:flex;
      gap:8px;
      align-items:center;
      justify-content:space-between;
      padding:10px 10px;
      border:1px solid var(--line);
      border-radius:14px;
      background:rgba(255,255,255,.02);
    }
    .snippet-item .meta{
      display:flex;
      flex-direction:column;
      gap:2px;
      min-width:0;
    }
    .snippet-item .name{
      font-size:13px;
      font-weight:700;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      max-width:180px;
    }
    .snippet-item .type{
      font-size:12px;
      color:var(--muted);
    }
    .snippet-actions{
      display:flex;
      gap:6px;
      flex-shrink:0;
    }
    .snippet-actions button{
      padding:7px 10px;
      border-radius:12px;
      font-size:12px;
    }

    /* منطقة المحرر */
    .main{
      flex:1;
      display:flex;
      flex-direction:row;
      height:100%;
    }

    .editor{
      width:50%;
      min-width:420px;
      background:#0a1020;
      border-right:1px solid var(--line);
      display:flex;
      flex-direction:column;
    }

    .tabs{
      display:flex;
      gap:8px;
      padding:10px;
      border-bottom:1px solid var(--line);
      background:rgba(255,255,255,.02);
    }
    .tab{
      padding:8px 10px;
      border-radius:999px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.02);
      color:var(--muted);
      cursor:pointer;
      font-weight:700;
      font-size:12px;
    }
    .tab.active{
      color:var(--text);
      border-color:rgba(106,166,255,.55);
      background:rgba(106,166,255,.12);
    }

    .code-area{
      flex:1;
      display:flex;
      flex-direction:column;
      padding:10px;
      gap:10px;
      overflow:hidden;
    }

    .label-row{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .label-row .title{
      font-size:12px;
      color:var(--muted);
      font-weight:700;
    }
    .label-row .status{
      font-size:12px;
      color:var(--muted);
    }

    .code{
      flex:1;
      resize:none;
      width:100%;
      border:1px solid var(--line);
      border-radius: var(--radius);
      background:rgba(255,255,255,.03);
      padding:12px;
      color:var(--text);
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      font-size:13px;
      line-height:1.45;
      outline:none;
      overflow:auto;
    }

    iframe{
      width:50%;
      border:none;
      background:#fff;
      height:100%;
    }

    .toast{
      position:fixed;
      left:18px;
      bottom:18px;
      background:rgba(16,28,51,.92);
      border:1px solid var(--line);
      color:var(--text);
      padding:10px 12px;
      border-radius:14px;
      box-shadow: var(--shadow);
      font-size:12.5px;
      opacity:0;
      transform:translateY(10px);
      pointer-events:none;
      transition:.18s ease;
    }
    .toast.show{
      opacity:1;
      transform:translateY(0);
    }

    @media (max-width: 980px){
      body{overflow:auto}
      .app{flex-direction:column; height:auto;}
      .control{width:100%; border-left:none; border-top:1px solid var(--line);}
      .main{flex-direction:column;}
      .editor, iframe{width:100%; min-width:unset; height:70vh;}
      iframe{height:70vh;}
    }
  </style>
</head>

<body>
  <div class="app">
    <!-- منطقة المحرر + المعاينة -->
    <div class="main">
      <div class="editor">
        <div class="tabs">
          <div class="tab active" data-tab="html">HTML</div>
          <div class="tab" data-tab="css">CSS</div>
          <div class="tab" data-tab="js">JS</div>
        </div>

        <div class="code-area">
          <div class="label-row">
            <div class="title" id="activeTitle">محرر HTML</div>
            <div class="status" id="saveStatus">غير محفوظ</div>
          </div>

          <textarea class="code" id="editor"></textarea>
        </div>
      </div>

      <iframe id="preview"></iframe>
    </div>

    <!-- لوحة التحكم -->
    <aside class="control">
      <div class="brand">
        <h1>لوحة التحكم</h1>
        <span class="pill">Ctrl+Enter تشغيل</span>
      </div>

      <div class="section">
        <h2>أدوات سريعة</h2>
        <div class="grid2">
          <button class="btn-primary" id="btnRun">تشغيل</button>
          <button class="btn-ok" id="btnSave">حفظ</button>
          <button class="btn-warn" id="btnDownload">تنزيل HTML</button>
          <button id="btnCopy">نسخ الكل</button>
          <button class="btn-danger" id="btnClear">مسح المحرر الحالي</button>
          <button class="btn-danger" id="btnReset">إعادة ضبط</button>
        </div>
        <p class="hint" style="margin-top:10px">
          سيتم حفظ الأكواد والاختصارات تلقائياً داخل المتصفح (localStorage).
        </p>
      </div>

      <div class="section">
        <h2>إعدادات</h2>
        <div class="grid1">
          <label class="hint" for="autoRun">
            <input type="checkbox" id="autoRun" style="width:auto; margin-left:8px;">
            تشغيل تلقائي عند الكتابة (بعد ثانية)
          </label>

          <label class="hint" for="wrap">
            <input type="checkbox" id="wrap" style="width:auto; margin-left:8px;" checked>
            لفّ السطور (Word Wrap)
          </label>
        </div>
      </div>

      <div class="section">
        <h2>إضافة اختصار / أداة مساعدة</h2>
        <div class="grid1">
          <input id="snipName" placeholder="اسم الاختصار (مثال: زر أنيق)"/>
          <select id="snipType">
            <option value="html">HTML</option>
            <option value="css">CSS</option>
            <option value="js">JS</option>
          </select>
          <textarea id="snipCode" class="small" placeholder="اكتب الكود هنا..."></textarea>
          <button class="btn-primary" id="btnAddSnippet">إضافة الاختصار</button>
          <p class="hint">
            عند الضغط على “إدراج” سيتم إدخال الكود في مكان المؤشر داخل المحرر الحالي.
          </p>
        </div>
      </div>

      <div class="section">
        <h2>الاختصارات المحفوظة</h2>
        <div class="snippets" id="snippetsList"></div>
        <p class="hint" id="snipEmpty" style="margin:10px 0 0; display:none;">
          لا توجد اختصارات بعد. أضف أول اختصار من الأعلى.
        </p>
      </div>

      <div class="section">
        <h2>اختصارات لوحة المفاتيح</h2>
        <p class="hint">
          Ctrl + Enter: تشغيل<br/>
          Ctrl + S: حفظ<br/>
          Ctrl + Shift + C: نسخ الكل<br/>
          Ctrl + Shift + R: إعادة ضبط
        </p>
      </div>
    </aside>
  </div>

  <div class="toast" id="toast"></div>

  <script>
    // ---------- مفاتيح التخزين ----------
    const LS_KEYS = {
      html: "pen_html_v1",
      css: "pen_css_v1",
      js: "pen_js_v1",
      snippets: "pen_snippets_v1",
      settings: "pen_settings_v1"
    };

    // ---------- عناصر ----------
    const tabs = document.querySelectorAll(".tab");
    const editor = document.getElementById("editor");
    const preview = document.getElementById("preview");
    const activeTitle = document.getElementById("activeTitle");
    const saveStatus = document.getElementById("saveStatus");
    const toast = document.getElementById("toast");

    const btnRun = document.getElementById("btnRun");
    const btnSave = document.getElementById("btnSave");
    const btnClear = document.getElementById("btnClear");
    const btnReset = document.getElementById("btnReset");
    const btnCopy = document.getElementById("btnCopy");
    const btnDownload = document.getElementById("btnDownload");

    const autoRunEl = document.getElementById("autoRun");
    const wrapEl = document.getElementById("wrap");

    const snipName = document.getElementById("snipName");
    const snipType = document.getElementById("snipType");
    const snipCode = document.getElementById("snipCode");
    const btnAddSnippet = document.getElementById("btnAddSnippet");
    const snippetsList = document.getElementById("snippetsList");
    const snipEmpty = document.getElementById("snipEmpty");

    // ---------- حالة ----------
    let activeTab = "html";
    let autoRunTimer = null;

    const defaultState = {
      html: `<h1 style="font-family:system-ui">Hello World</h1>
<p>هذا محرر بسيط مثل CodePen مع لوحة تحكم.</p>
<button id="btn">اضغطني</button>`,
      css: `body{ margin:20px; font-family:system-ui; }
button{ padding:10px 14px; border-radius:12px; border:1px solid #ddd; cursor:pointer; }`,
      js: `document.getElementById("btn")?.addEventListener("click", ()=> alert("تم!"));`
    };

    // ---------- أدوات مساعدة ----------
    function showToast(msg){
      toast.textContent = msg;
      toast.classList.add("show");
      setTimeout(()=> toast.classList.remove("show"), 1400);
    }

    function getAllCode(){
      return {
        html: localStorage.getItem(LS_KEYS.html) ?? defaultState.html,
        css: localStorage.getItem(LS_KEYS.css) ?? defaultState.css,
        js: localStorage.getItem(LS_KEYS.js) ?? defaultState.js
      };
    }

    function setCode(type, value){
      localStorage.setItem(LS_KEYS[type], value);
      saveStatus.textContent = "محفوظ";
      saveStatus.style.color = "var(--ok)";
      setTimeout(()=> {
        saveStatus.textContent = "محفوظ";
        saveStatus.style.color = "var(--muted)";
      }, 600);
    }

    function setDirty(){
      saveStatus.textContent = "غير محفوظ";
      saveStatus.style.color = "var(--warn)";
    }

    function buildPreview(){
      const { html, css, js } = getAllCode();
      const doc = `
<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<style>${css}</style>
</head>
<body>
${html}
<script>
try {
${js}
} catch(e) {
  const pre = document.createElement('pre');
  pre.style.cssText = 'background:#111;color:#ffb4b4;padding:12px;border-radius:12px;white-space:pre-wrap;';
  pre.textContent = 'JS Error: ' + (e && e.message ? e.message : e);
  document.body.appendChild(pre);
}
<\/script>
</body>
</html>`;
      preview.srcdoc = doc;
    }

    function updateEditorFromStorage(){
      const { html, css, js } = getAllCode();
      const map = { html, css, js };
      editor.value = map[activeTab];
      applyWrapSetting();
      setDirty(); // لأننا نعرض كود ممكن يعدله
      saveStatus.textContent = "محفوظ";
      saveStatus.style.color = "var(--muted)";
    }

    function switchTab(type){
      activeTab = type;
      tabs.forEach(t => t.classList.toggle("active", t.dataset.tab === type));
      activeTitle.textContent = `محرر ${type.toUpperCase()}`;
      updateEditorFromStorage();
    }

    function applyWrapSetting(){
      editor.style.whiteSpace = wrapEl.checked ? "pre-wrap" : "pre";
    }

    // إدراج نص في مكان المؤشر
    function insertAtCursor(text){
      const start = editor.selectionStart;
      const end = editor.selectionEnd;
      const before = editor.value.slice(0, start);
      const after = editor.value.slice(end);
      editor.value = before + text + after;
      const pos = start + text.length;
      editor.focus();
      editor.setSelectionRange(pos, pos);
      setDirty();
    }

    // ---------- الاختصارات (Snippets) ----------
    function loadSnippets(){
      try{
        return JSON.parse(localStorage.getItem(LS_KEYS.snippets) || "[]");
      }catch{
        return [];
      }
    }

    function saveSnippets(list){
      localStorage.setItem(LS_KEYS.snippets, JSON.stringify(list));
    }

    function renderSnippets(){
      const list = loadSnippets();
      snippetsList.innerHTML = "";

      snipEmpty.style.display = list.length ? "none" : "block";

      list.forEach((snip, idx) => {
        const row = document.createElement("div");
        row.className = "snippet-item";

        const meta = document.createElement("div");
        meta.className = "meta";
        meta.innerHTML = `<div class="name" title="${escapeHtml(snip.name)}">${escapeHtml(snip.name)}</div>
                          <div class="type">النوع: ${snip.type.toUpperCase()}</div>`;

        const actions = document.createElement("div");
        actions.className = "snippet-actions";

        const btnInsert = document.createElement("button");
        btnInsert.textContent = "إدراج";
        btnInsert.className = "btn-primary";
        btnInsert.onclick = () => {
          // لو النوع مختلف، ننتقل له أولاً ثم ندرج
          if (activeTab !== snip.type){
            switchTab(snip.type);
          }
          insertAtCursor("\n" + snip.code + "\n");
          showToast("تم إدراج الاختصار");
        };

        const btnDel = document.createElement("button");
        btnDel.textContent = "حذف";
        btnDel.className = "btn-danger";
        btnDel.onclick = () => {
          const updated = loadSnippets().filter((_, i) => i !== idx);
          saveSnippets(updated);
          renderSnippets();
          showToast("تم حذف الاختصار");
        };

        actions.appendChild(btnInsert);
        actions.appendChild(btnDel);

        row.appendChild(meta);
        row.appendChild(actions);
        snippetsList.appendChild(row);
      });
    }

    function escapeHtml(str){
      return String(str)
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#039;");
    }

    // ---------- الإعدادات ----------
    function loadSettings(){
      try{
        return JSON.parse(localStorage.getItem(LS_KEYS.settings) || "{}");
      }catch{
        return {};
      }
    }
    function saveSettings(obj){
      localStorage.setItem(LS_KEYS.settings, JSON.stringify(obj));
    }
    function applySettings(){
      const s = loadSettings();
      autoRunEl.checked = !!s.autoRun;
      wrapEl.checked = s.wrap !== undefined ? !!s.wrap : true;
      applyWrapSetting();
    }

    // ---------- أحداث ----------
    tabs.forEach(t => t.addEventListener("click", () => switchTab(t.dataset.tab)));

    editor.addEventListener("input", () => {
      setDirty();
      if (autoRunEl.checked){
        clearTimeout(autoRunTimer);
        autoRunTimer = setTimeout(() => {
          // حفظ سريع قبل التشغيل
          setCode(activeTab, editor.value);
          buildPreview();
          showToast("تم التشغيل تلقائياً");
        }, 1000);
      }
    });

    btnRun.addEventListener("click", () => {
      // حفظ المحتوى الحالي ثم التشغيل
      setCode(activeTab, editor.value);
      buildPreview();
      showToast("تم التشغيل");
    });

    btnSave.addEventListener("click", () => {
      setCode(activeTab, editor.value);
      showToast("تم الحفظ");
    });

    btnClear.addEventListener("click", () => {
      editor.value = "";
      setDirty();
      showToast("تم المسح");
    });

    btnReset.addEventListener("click", () => {
      localStorage.setItem(LS_KEYS.html, defaultState.html);
      localStorage.setItem(LS_KEYS.css, defaultState.css);
      localStorage.setItem(LS_KEYS.js, defaultState.js);
      switchTab(activeTab);
      buildPreview();
      showToast("تمت إعادة الضبط");
    });

    btnCopy.addEventListener("click", async () => {
      const all = getAllCode();
      const text = `<!-- HTML -->\n${all.html}\n\n/* CSS */\n${all.css}\n\n// JS\n${all.js}\n`;
      try{
        await navigator.clipboard.writeText(text);
        showToast("تم النسخ");
      }catch{
        showToast("تعذر النسخ (صلاحيات المتصفح)");
      }
    });

    btnDownload.addEventListener("click", () => {
      // حفظ أولاً
      setCode(activeTab, editor.value);

      const { html, css, js } = getAllCode();
      const content = `<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Export</title>
<style>
${css}
</style>
</head>
<body>
${html}
<script>
${js}
<\/script>
</body>
</html>`;
      const blob = new Blob([content], { type: "text/html;charset=utf-8" });
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = "export.html";
      a.click();
      URL.revokeObjectURL(a.href);
      showToast("تم تنزيل الملف");
    });

    autoRunEl.addEventListener("change", () => {
      const s = loadSettings();
      s.autoRun = autoRunEl.checked;
      saveSettings(s);
      showToast(autoRunEl.checked ? "تم تفعيل التشغيل التلقائي" : "تم إيقاف التشغيل التلقائي");
    });

    wrapEl.addEventListener("change", () => {
      const s = loadSettings();
      s.wrap = wrapEl.checked;
      saveSettings(s);
      applyWrapSetting();
      showToast(wrapEl.checked ? "تم تفعيل لفّ السطور" : "تم إيقاف لفّ السطور");
    });

    btnAddSnippet.addEventListener("click", () => {
      const name = snipName.value.trim();
      const type = snipType.value;
      const code = snipCode.value.trim();

      if (!name || !code){
        showToast("اكتب اسم الاختصار والكود");
        return;
      }

      const list = loadSnippets();
      list.unshift({ name, type, code, createdAt: Date.now() });
      saveSnippets(list);

      snipName.value = "";
      snipCode.value = "";
      renderSnippets();
      showToast("تمت إضافة الاختصار");
    });

    // ---------- اختصارات لوحة المفاتيح ----------
    document.addEventListener("keydown", (e) => {
      const isCtrl = e.ctrlKey || e.metaKey;

      if (isCtrl && e.key === "Enter"){
        e.preventDefault();
        setCode(activeTab, editor.value);
        buildPreview();
        showToast("تم التشغيل");
      }

      if (isCtrl && (e.key.toLowerCase() === "s")){
        e.preventDefault();
        setCode(activeTab, editor.value);
        showToast("تم الحفظ");
      }

      if (isCtrl && e.shiftKey && e.key.toLowerCase() === "r"){
        e.preventDefault();
        localStorage.setItem(LS_KEYS.html, defaultState.html);
        localStorage.setItem(LS_KEYS.css, defaultState.css);
        localStorage.setItem(LS_KEYS.js, defaultState.js);
        switchTab(activeTab);
        buildPreview();
        showToast("تمت إعادة الضبط");
      }

      if (isCtrl && e.shiftKey && e.key.toLowerCase() === "c"){
        e.preventDefault();
        btnCopy.click();
      }
    });

    // ---------- بدء التشغيل ----------
    (function init(){
      // تحميل الإعدادات
      applySettings();

      // تحميل الأكواد الافتراضية أول مرة فقط
      if (!localStorage.getItem(LS_KEYS.html)) localStorage.setItem(LS_KEYS.html, defaultState.html);
      if (!localStorage.getItem(LS_KEYS.css)) localStorage.setItem(LS_KEYS.css, defaultState.css);
      if (!localStorage.getItem(LS_KEYS.js)) localStorage.setItem(LS_KEYS.js, defaultState.js);

      // تحميل المحرر والمعاينة
      switchTab("html");
      buildPreview();

      // عرض الاختصارات
      renderSnippets();
    })();
  </script>
</body>
</html>
