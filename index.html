<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Dark Code</title>

<style>
  :root{
    --bg:#0b0f14; --panel:#0f1621; --panel2:#0c121b;
    --text:#e6eefc; --muted:#9bb0d0; --border:rgba(255,255,255,.10);
    --accent:#3b82f6; --accent2:#8b5dff; --danger:#ff5d7a;
    --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    --sans: system-ui, -apple-system, Segoe UI, Roboto, Arial, "Noto Sans Arabic", sans-serif;
    --radius:14px;
    --shadow: 0 18px 50px rgba(0,0,0,.55);
  }

  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;
    background:
      radial-gradient(900px 500px at 15% 10%, rgba(59,130,246,.14), transparent 60%),
      radial-gradient(900px 500px at 85% 15%, rgba(139,93,255,.12), transparent 55%),
      var(--bg);
    color:var(--text);
    font-family:var(--sans);
    display:flex;
    flex-direction:column;
  }

  /* Topbar */
  .topbar{
    height:56px;
    background: rgba(0,0,0,.25);
    border-bottom:1px solid var(--border);
    display:flex;
    align-items:center;
    padding:0 14px;
    gap:12px;
    backdrop-filter: blur(10px);
  }
  .logo{
    width:34px; height:34px;
    background: linear-gradient(135deg, var(--accent), var(--accent2));
    color:#fff;
    border-radius:10px;
    display:flex;
    align-items:center;
    justify-content:center;
    font-weight:800;
    font-family:var(--sans);
    flex:0 0 auto;
  }
  .site-name{font-weight:800; letter-spacing:.2px}
  .sub{color:var(--muted); font-size:12px}
  .spacer{flex:1}
  .actions{display:flex; gap:8px; flex-wrap:wrap; align-items:center}
  .btn{
    border:1px solid var(--border);
    background: rgba(255,255,255,.04);
    color:var(--text);
    padding:9px 10px;
    border-radius:12px;
    cursor:pointer;
    font-size:12px;
    transition:.15s ease;
    user-select:none;
  }
  .btn:hover{transform: translateY(-1px); background: rgba(255,255,255,.07);}
  .btn.primary{border-color: rgba(59,130,246,.5); background: rgba(59,130,246,.18);}
  .btn.danger{border-color: rgba(255,93,122,.35); background: rgba(255,93,122,.12);}
  .btn.help{
    width:38px; height:38px;
    display:inline-flex; align-items:center; justify-content:center;
    font-weight:900;
  }

  /* Layout */
  .main{
    flex:1;
    min-height:0;
    display:grid;
    grid-template-columns: 1.05fr .95fr;
    gap:12px;
    padding:12px;
  }

  .panel{
    border:1px solid var(--border);
    background: rgba(255,255,255,.03);
    border-radius: var(--radius);
    overflow:hidden;
    display:flex;
    flex-direction:column;
    min-height:0;
  }
  .panel-head{
    padding:10px 12px;
    border-bottom:1px solid var(--border);
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:10px;
    background: rgba(0,0,0,.18);
  }
  .panel-head h2{margin:0; font-size:13px}
  .panel-body{padding:10px; display:flex; flex-direction:column; gap:10px; min-height:0;}

  /* Editor + Tabs */
  .tabs{display:flex; gap:8px; flex-wrap:wrap}
  .tab{
    border:1px solid var(--border);
    background: rgba(255,255,255,.02);
    color:var(--muted);
    padding:7px 10px;
    border-radius:12px;
    cursor:pointer;
    font-size:12px;
    transition:.15s ease;
    user-select:none;
  }
  .tab.active{
    color:var(--text);
    border-color: rgba(59,130,246,.5);
    background: rgba(59,130,246,.16);
  }

  textarea{
    width:100%;
    flex:1;
    min-height:0;
    resize:none;
    border:1px solid var(--border);
    border-radius: 12px;
    padding:12px;
    background: rgba(0,0,0,.25);
    color:var(--text);
    font-family: var(--mono);
    font-size:13px;
    line-height:1.6;
    outline:none;
  }
  textarea:focus{
    border-color: rgba(59,130,246,.55);
    box-shadow: 0 0 0 3px rgba(59,130,246,.12);
  }

  /* Files list */
  .files-wrap{display:grid; grid-template-columns: 1fr; gap:8px;}
  .file-item{
    border:1px solid var(--border);
    background: rgba(0,0,0,.18);
    border-radius:12px;
    padding:10px;
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:10px;
  }
  .file-meta{display:flex; flex-direction:column; gap:2px; min-width:0;}
  .file-name{font-size:12px; font-weight:700; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; max-width:320px;}
  .file-type{font-size:11px; color:var(--muted)}
  .file-actions{display:flex; gap:8px; flex:0 0 auto;}
  .mini{padding:7px 9px; border-radius:10px; font-size:11px;}

  /* Preview */
  .preview-body{padding:0; min-height:0; flex:1;}
  iframe{width:100%; height:100%; border:0; background:white;}

  /* Footer/status */
  .status{
    display:flex;
    align-items:center;
    gap:8px;
    color:var(--muted);
    font-size:12px;
    padding:2px 2px 0 2px;
    flex-wrap:wrap;
  }
  .sep{opacity:.5}

  /* Modal (Help) */
  .backdrop{
    position:fixed;
    inset:0;
    background: rgba(0,0,0,.55);
    display:none;
    align-items:center;
    justify-content:center;
    padding:16px;
    z-index:9999;
  }
  .backdrop.open{display:flex;}
  .modal{
    width:min(920px, 100%);
    max-height: min(82vh, 820px);
    overflow:hidden;
    border:1px solid var(--border);
    background: rgba(15,22,33,.92);
    border-radius: 18px;
    box-shadow: var(--shadow);
    backdrop-filter: blur(12px);
    display:flex;
    flex-direction:column;
  }
  .modal-head{
    padding:12px 14px;
    border-bottom:1px solid var(--border);
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:10px;
    background: rgba(0,0,0,.18);
  }
  .modal-title{
    display:flex;
    flex-direction:column;
    gap:2px;
  }
  .modal-title strong{font-size:13px}
  .modal-title span{font-size:12px; color:var(--muted)}
  .modal-body{
    padding:12px 14px;
    overflow:auto;
    display:grid;
    gap:14px;
  }
  .cards{
    display:grid;
    grid-template-columns: 1fr 1fr;
    gap:12px;
  }
  .card{
    border:1px solid var(--border);
    background: rgba(0,0,0,.18);
    border-radius: 16px;
    padding:12px;
    display:flex;
    flex-direction:column;
    gap:10px;
  }
  .card h3{margin:0; font-size:13px}
  .card p{margin:0; color:var(--muted); font-size:12px; line-height:1.6}
  .kbd{
    display:inline-flex;
    align-items:center;
    justify-content:center;
    padding:2px 8px;
    border-radius:10px;
    border:1px solid var(--border);
    background: rgba(255,255,255,.04);
    color: var(--text);
    font-family: var(--mono);
    font-size: 12px;
    margin: 0 3px;
    white-space:nowrap;
  }
  .list{
    display:grid;
    gap:8px;
  }
  .row{
    display:flex;
    gap:10px;
    align-items:flex-start;
    justify-content:space-between;
    border:1px solid var(--border);
    background: rgba(255,255,255,.03);
    border-radius:14px;
    padding:10px;
  }
  .row .desc{color:var(--muted); font-size:12px; line-height:1.5; flex:1;}
  .row .keys{display:flex; gap:6px; flex-wrap:wrap; justify-content:flex-start; min-width:220px;}
  .pill{
    display:inline-flex;
    padding:6px 10px;
    border-radius:999px;
    border:1px solid var(--border);
    background: rgba(59,130,246,.10);
    cursor:pointer;
    font-size:12px;
    user-select:none;
  }
  .pill:hover{background: rgba(59,130,246,.16);}

  @media (max-width: 980px){
    .main{grid-template-columns: 1fr;}
    .cards{grid-template-columns: 1fr;}
  }
</style>
</head>

<body>
  <div class="topbar">
    <div class="logo">DC</div>
    <div>
      <div class="site-name">Dark Code</div>
      <div class="sub">محرر أكواد + معاينة مباشرة + ملفات + اختصارات</div>
    </div>

    <div class="spacer"></div>

    <div class="actions">
      <button class="btn primary" id="btnRun" title="تشغيل (Ctrl + Enter)">تشغيل</button>
      <button class="btn" id="btnImportCode" title="استيراد ملف HTML/CSS/JS (Ctrl + O)">استيراد ملف للكود</button>
      <button class="btn" id="btnAddAsset" title="إضافة ملفات للمشروع (Ctrl + Shift + O)">إضافة ملف للمشروع</button>
      <button class="btn" id="btnExportProject" title="تصدير المشروع (Ctrl + S)">تصدير مشروع</button>
      <button class="btn" id="btnImportProject" title="استيراد مشروع JSON">استيراد مشروع</button>
      <button class="btn danger" id="btnReset" title="مسح كل شيء">مسح الكل</button>
      <button class="btn help" id="btnHelp" title="الاختصارات والمساعدة (F1)">؟</button>
    </div>
  </div>

  <div class="main">
    <!-- Editor panel -->
    <section class="panel">
      <div class="panel-head">
        <h2>المحرر</h2>
        <div class="tabs">
          <button class="tab active" data-tab="html">HTML</button>
          <button class="tab" data-tab="css">CSS</button>
          <button class="tab" data-tab="js">JS</button>
          <button class="tab" data-tab="files">الملفات</button>
        </div>
      </div>

      <div class="panel-body" style="flex:1;">
        <textarea id="codeArea" spellcheck="false"></textarea>

        <!-- Files view -->
        <div id="filesView" style="display:none; flex:1; min-height:0; overflow:auto;">
          <div class="status" style="margin-bottom:8px;">
            <span>الملفات الإضافية تنحقن داخل المعاينة تلقائيًا.</span>
            <span class="sep">•</span>
            <span>JS ⇦ script ، CSS ⇦ style</span>
          </div>
          <div class="files-wrap" id="filesList"></div>
          <div class="status">
            <span id="filesCount">0 ملفات</span>
            <span class="sep">•</span>
            <span>الحفظ تلقائي</span>
          </div>
        </div>

        <div class="status">
          <span id="statusText">جاهز</span>
          <span class="sep">•</span>
          <label style="display:flex; align-items:center; gap:8px;">
            <input type="checkbox" id="autoRun" checked />
            <span>تحديث مباشر</span>
          </label>
          <span class="sep">•</span>
          <span title="اختصار سريع للمساعدة: F1">مساعدة: F1</span>
        </div>
      </div>
    </section>

    <!-- Preview panel -->
    <section class="panel">
      <div class="panel-head">
        <h2>المعاينة (يمين)</h2>
        <div class="status" style="padding:0; margin:0;">
          <span>خط Tajawal داخل المعاينة</span>
        </div>
      </div>
      <div class="preview-body">
        <iframe id="result" sandbox="allow-scripts"></iframe>
      </div>
    </section>
  </div>

  <!-- Hidden inputs for file picking -->
  <input id="fileInputCode" type="file" style="display:none" accept=".html,.htm,.css,.js,.txt" />
  <input id="fileInputAsset" type="file" style="display:none" multiple accept=".js,.css,.txt,.json" />
  <input id="fileInputProject" type="file" style="display:none" accept=".json" />

  <!-- Help Modal -->
  <div class="backdrop" id="helpBackdrop" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-label="مساعدة واختصارات">
      <div class="modal-head">
        <div class="modal-title">
          <strong>قائمة الاختصارات + أدوات تسهيل البرمجة</strong>
          <span>استخدم الاختصارات لتسريع شغلك، أو اضغط على الأدوات لإضافة أكواد جاهزة.</span>
        </div>
        <div style="display:flex; gap:8px; align-items:center;">
          <button class="btn" id="btnCloseHelp" title="إغلاق (Esc)">إغلاق</button>
        </div>
      </div>

      <div class="modal-body">
        <div class="cards">
          <div class="card">
            <h3>اختصارات أساسية</h3>
            <div class="list">
              <div class="row">
                <div class="desc">تشغيل/تحديث المعاينة</div>
                <div class="keys">
                  <span class="kbd">Ctrl</span><span class="kbd">Enter</span>
                </div>
              </div>
              <div class="row">
                <div class="desc">تصدير المشروع (JSON)</div>
                <div class="keys">
                  <span class="kbd">Ctrl</span><span class="kbd">S</span>
                </div>
              </div>
              <div class="row">
                <div class="desc">استيراد ملف للكود (HTML/CSS/JS)</div>
                <div class="keys">
                  <span class="kbd">Ctrl</span><span class="kbd">O</span>
                </div>
              </div>
              <div class="row">
                <div class="desc">إضافة ملفات للمشروع (Assets)</div>
                <div class="keys">
                  <span class="kbd">Ctrl</span><span class="kbd">Shift</span><span class="kbd">O</span>
                </div>
              </div>
              <div class="row">
                <div class="desc">فتح المساعدة</div>
                <div class="keys">
                  <span class="kbd">F1</span>
                </div>
              </div>
              <div class="row">
                <div class="desc">إغلاق المساعدة</div>
                <div class="keys">
                  <span class="kbd">Esc</span>
                </div>
              </div>
            </div>
            <p>ملاحظة: الحفظ تلقائي دائمًا، فلا تحتاج زر حفظ للكتابة.</p>
          </div>

          <div class="card">
            <h3>أدوات سريعة (Snippets)</h3>
            <p>اضغط زر لإضافة كود جاهز داخل التبويب الحالي (HTML/CSS/JS). تقدر بعدها تعدله.</p>
            <div style="display:flex; flex-wrap:wrap; gap:8px;">
              <span class="pill" data-snippet="html-basic">HTML: هيكل بسيط</span>
              <span class="pill" data-snippet="html-card">HTML: بطاقة (Card)</span>
              <span class="pill" data-snippet="css-center">CSS: توسيط + عرض جميل</span>
              <span class="pill" data-snippet="css-dark">CSS: خلفية داكنة</span>
              <span class="pill" data-snippet="js-click">JS: حدث زر</span>
              <span class="pill" data-snippet="js-fetch">JS: طلب بيانات (fetch)</span>
            </div>
            <p>إذا كنت على تبويب “الملفات”، ارجع لـ HTML/CSS/JS ثم استخدم الأدوات.</p>
          </div>
        </div>

        <div class="card">
          <h3>تعليم سريع</h3>
          <div class="list">
            <div class="row">
              <div class="desc">
                <strong>HTML</strong> يبني عناصر الصفحة (عناوين، أزرار، أقسام). مثال: <span class="kbd">&lt;h1&gt;</span>
              </div>
              <div class="keys"><span class="kbd">تبويب HTML</span></div>
            </div>
            <div class="row">
              <div class="desc">
                <strong>CSS</strong> ينسّق الشكل (ألوان، خطوط، مسافات). مثال: <span class="kbd">color</span>
              </div>
              <div class="keys"><span class="kbd">تبويب CSS</span></div>
            </div>
            <div class="row">
              <div class="desc">
                <strong>JS</strong> يضيف تفاعل (ضغط زر، حسابات، جلب بيانات). مثال: <span class="kbd">addEventListener</span>
              </div>
              <div class="keys"><span class="kbd">تبويب JS</span></div>
            </div>
            <div class="row">
              <div class="desc">
                لإضافة سكربتات/ستايلات كثيرة: استخدم <strong>إضافة ملف للمشروع</strong> (CSS/JS) وستعمل تلقائيًا داخل المعاينة.
              </div>
              <div class="keys"><span class="kbd">الملفات</span></div>
            </div>
          </div>
        </div>

      </div>
    </div>
  </div>

<script>
/* =========================
   Storage + State
========================= */
const STORAGE_KEY = "darkcode.project.v3";

const codeArea = document.getElementById("codeArea");
const resultFrame = document.getElementById("result");
const statusText = document.getElementById("statusText");
const autoRun = document.getElementById("autoRun");

const filesView = document.getElementById("filesView");
const filesList = document.getElementById("filesList");
const filesCount = document.getElementById("filesCount");

const fileInputCode = document.getElementById("fileInputCode");
const fileInputAsset = document.getElementById("fileInputAsset");
const fileInputProject = document.getElementById("fileInputProject");

const tabs = Array.from(document.querySelectorAll(".tab"));

const helpBackdrop = document.getElementById("helpBackdrop");
const btnHelp = document.getElementById("btnHelp");
const btnCloseHelp = document.getElementById("btnCloseHelp");

let activeTab = "html";

/*
  assets: [
    { id, name, type: "js"|"css"|"txt"|"json", content }
  ]
*/
let state = {
  html: "<h1>Hello World</h1>\n<p>اكتب كودك وشوف النتيجة.</p>\n<button id=\"btn\">اضغطني</button>",
  css: "body{background:#f2f2f2; text-align:center; padding:18px}\nh1{color:blue}",
  js: "document.getElementById('btn')?.addEventListener('click',()=>alert('يشتغل!'));",
  assets: []
};

function setStatus(msg){
  statusText.textContent = msg;
  clearTimeout(setStatus._t);
  setStatus._t = setTimeout(()=> statusText.textContent = "جاهز", 1200);
}

function save(){
  localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
}

function load(){
  const raw = localStorage.getItem(STORAGE_KEY);
  if(!raw) return;
  try{
    const parsed = JSON.parse(raw);
    if(parsed && typeof parsed === "object"){
      state = {
        html: parsed.html ?? state.html,
        css: parsed.css ?? state.css,
        js: parsed.js ?? state.js,
        assets: Array.isArray(parsed.assets) ? parsed.assets : []
      };
    }
  }catch{}
}

/* =========================
   Tabs + Editor binding
========================= */
function applyActiveTabToEditor(){
  if(activeTab === "files"){
    codeArea.style.display = "none";
    filesView.style.display = "block";
    renderFiles();
    return;
  }
  filesView.style.display = "none";
  codeArea.style.display = "block";
  codeArea.value = state[activeTab] ?? "";
}

function commitEditorToState(){
  if(activeTab === "files") return;
  state[activeTab] = codeArea.value;
  save();
}

function setActiveTab(tab){
  activeTab = tab;
  tabs.forEach(t=>{
    const is = t.dataset.tab === tab;
    t.classList.toggle("active", is);
  });
  applyActiveTabToEditor();
  if(activeTab !== "files") codeArea.focus();
  setStatus(`تبويب: ${tab.toUpperCase()}`);
}

/* =========================
   Preview build (inject assets)
========================= */
function buildAssetsInjection(){
  const cssAssets = state.assets
    .filter(a => a.type === "css")
    .map(a => a.content)
    .join("\n\n/* ---- asset ---- */\n\n");

  const jsAssets  = state.assets
    .filter(a => a.type === "js")
    .map(a => a.content)
    .join("\n\n// ---- asset ----\n\n");

  return { cssAssets, jsAssets };
}

function run(){
  commitEditorToState();

  const { cssAssets, jsAssets } = buildAssetsInjection();

  const output = `
<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />

<link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700&display=swap" rel="stylesheet">

<style>
body{ font-family:'Tajawal', sans-serif; }
${state.css || ""}

/* ===== CSS Assets ===== */
${cssAssets || ""}
</style>
</head>
<body>
${state.html || ""}

<script>
try{
${state.js || ""}

/* ===== JS Assets ===== */
${jsAssets || ""}
}catch(e){
  document.body.insertAdjacentHTML('beforeend',
    '<pre style="white-space:pre-wrap;background:#fee2e2;color:#7f1d1d;padding:12px;border-radius:12px;margin-top:12px;">JS Error: ' + e + '</pre>'
  );
  console.error(e);
}
<\/script>
</body>
</html>`;
  resultFrame.srcdoc = output;
  setStatus("تم التحديث");
}

let debounceT = null;
function scheduleRun(){
  if(!autoRun.checked) return;
  clearTimeout(debounceT);
  debounceT = setTimeout(run, 200);
}

/* =========================
   Files (Assets) management
========================= */
function extToType(name){
  const n = (name || "").toLowerCase();
  if(n.endsWith(".js")) return "js";
  if(n.endsWith(".css")) return "css";
  if(n.endsWith(".json")) return "json";
  return "txt";
}

function uid(){
  return Math.random().toString(16).slice(2) + Date.now().toString(16);
}

function renderFiles(){
  filesList.innerHTML = "";
  filesCount.textContent = `${state.assets.length} ملفات`;

  if(state.assets.length === 0){
    const empty = document.createElement("div");
    empty.className = "status";
    empty.textContent = "لا توجد ملفات إضافية. اضغط (إضافة ملف للمشروع).";
    filesList.appendChild(empty);
    return;
  }

  state.assets.forEach(asset=>{
    const row = document.createElement("div");
    row.className = "file-item";

    const meta = document.createElement("div");
    meta.className = "file-meta";

    const name = document.createElement("div");
    name.className = "file-name";
    name.textContent = asset.name;

    const type = document.createElement("div");
    type.className = "file-type";
    type.textContent = `النوع: ${asset.type.toUpperCase()} • يشتغل داخل المعاينة: ${asset.type === "js" || asset.type === "css" ? "نعم" : "لا"}`;

    meta.appendChild(name);
    meta.appendChild(type);

    const acts = document.createElement("div");
    acts.className = "file-actions";

    const btnView = document.createElement("button");
    btnView.className = "btn mini";
    btnView.textContent = "عرض/تعديل";
    btnView.onclick = () => openAssetEditor(asset.id);

    const btnRemove = document.createElement("button");
    btnRemove.className = "btn mini danger";
    btnRemove.textContent = "حذف";
    btnRemove.onclick = () => removeAsset(asset.id);

    acts.appendChild(btnView);
    acts.appendChild(btnRemove);

    row.appendChild(meta);
    row.appendChild(acts);
    filesList.appendChild(row);
  });
}

function removeAsset(id){
  state.assets = state.assets.filter(a => a.id !== id);
  save();
  renderFiles();
  run();
  setStatus("تم حذف الملف");
}

function openAssetEditor(id){
  const asset = state.assets.find(a => a.id === id);
  if(!asset) return;

  const newContent = prompt(
    `تعديل محتوى الملف: ${asset.name}\n(انسخ/الصق وعدّل ثم OK)\nملاحظة: للمحتوى الطويل جدًا يفضل تصدير/استيراد مشروع.`,
    asset.content
  );
  if(newContent === null) return;
  asset.content = newContent;
  save();
  renderFiles();
  run();
  setStatus("تم تعديل الملف");
}

/* =========================
   Import code (into editor)
========================= */
async function readFileText(file){
  return await file.text();
}

async function importCodeFile(file){
  const text = await readFileText(file);
  const type = extToType(file.name);

  if(type === "js" || type === "css"){
    state[type] = text;
    save();
    setActiveTab(type);
    run();
    setStatus(`تم استيراد ${file.name}`);
    return;
  }
  if(file.name.toLowerCase().endsWith(".html") || file.name.toLowerCase().endsWith(".htm")){
    state.html = text;
    save();
    setActiveTab("html");
    run();
    setStatus(`تم استيراد ${file.name}`);
    return;
  }

  const where = prompt("الملف TXT. تبيه يروح وين؟ اكتب: html أو css أو js", "html");
  const w = (where || "html").toLowerCase().trim();
  if(["html","css","js"].includes(w)){
    state[w] = text;
    save();
    setActiveTab(w);
    run();
    setStatus(`تم استيراد ${file.name}`);
  }else{
    setStatus("تم إلغاء الاستيراد");
  }
}

/* =========================
   Add assets (multiple files)
========================= */
async function addAssetFiles(fileList){
  const files = Array.from(fileList || []);
  for(const f of files){
    const type = extToType(f.name);
    const content = await readFileText(f);

    state.assets.push({
      id: uid(),
      name: f.name,
      type,
      content
    });
  }
  save();
  if(activeTab === "files") renderFiles();
  run();
  setStatus("تمت إضافة الملفات");
}

/* =========================
   Export/Import project JSON
========================= */
function downloadText(filename, text){
  const blob = new Blob([text], {type:"application/json;charset=utf-8"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
}

function exportProject(){
  const payload = JSON.stringify(state, null, 2);
  const filename = `darkcode-project-${new Date().toISOString().slice(0,10)}.json`;
  downloadText(filename, payload);
  setStatus("تم تصدير المشروع");
}

async function importProjectFile(file){
  const text = await readFileText(file);
  try{
    const parsed = JSON.parse(text);
    if(!parsed || typeof parsed !== "object") throw new Error("bad");
    state = {
      html: parsed.html ?? "",
      css: parsed.css ?? "",
      js: parsed.js ?? "",
      assets: Array.isArray(parsed.assets) ? parsed.assets : []
    };
    save();
    setActiveTab("html");
    run();
    setStatus("تم استيراد المشروع");
  }catch{
    setStatus("ملف المشروع غير صالح");
  }
}

/* =========================
   Help modal
========================= */
function openHelp(){
  helpBackdrop.classList.add("open");
  helpBackdrop.setAttribute("aria-hidden","false");
  setStatus("تم فتح المساعدة");
}
function closeHelp(){
  helpBackdrop.classList.remove("open");
  helpBackdrop.setAttribute("aria-hidden","true");
  setStatus("تم إغلاق المساعدة");
}
btnHelp.addEventListener("click", openHelp);
btnCloseHelp.addEventListener("click", closeHelp);
helpBackdrop.addEventListener("click", (e)=>{
  if(e.target === helpBackdrop) closeHelp();
});

/* =========================
   Snippets
========================= */
const SNIPPETS = {
  "html-basic": `<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>صفحة</title>
</head>
<body>
  <h1>عنوان الصفحة</h1>
  <p>نص بسيط</p>
</body>
</html>`,
  "html-card": `<div class="card">
  <h2>بطاقة</h2>
  <p>هذا مثال بطاقة بسيطة.</p>
  <button id="btn">زر</button>
</div>`,
  "css-center": `body{
  min-height:100vh;
  display:flex;
  align-items:center;
  justify-content:center;
  padding:20px;
}
.card{
  width:min(520px, 100%);
  border:1px solid rgba(0,0,0,.12);
  border-radius:16px;
  padding:16px;
  background:white;
}`,
  "css-dark": `body{
  background:#0b1220;
  color:#e5e7eb;
}
a{color:#93c5fd}
button{
  border:1px solid rgba(255,255,255,.14);
  background: rgba(59,130,246,.18);
  color:#fff;
  padding:10px 12px;
  border-radius:12px;
  cursor:pointer;
}`,
  "js-click": `document.getElementById("btn")?.addEventListener("click", ()=>{
  alert("تم الضغط!");
});`,
  "js-fetch": `async function load(){
  const res = await fetch("https://jsonplaceholder.typicode.com/todos/1");
  const data = await res.json();
  console.log(data);
}
load();`
};

function insertSnippet(snippetKey){
  if(activeTab === "files"){
    setStatus("اختر تبويب HTML/CSS/JS أولاً");
    return;
  }
  const text = SNIPPETS[snippetKey];
  if(!text) return;

  // Insert at cursor (or append if no focus)
  const start = codeArea.selectionStart ?? codeArea.value.length;
  const end = codeArea.selectionEnd ?? codeArea.value.length;

  const before = codeArea.value.slice(0, start);
  const after = codeArea.value.slice(end);

  const insert = (before && !before.endsWith("\n")) ? "\n\n" + text : text;
  const final = before + insert + "\n\n" + after;

  codeArea.value = final;
  commitEditorToState();
  scheduleRun();
  setStatus("تم إدخال كود جاهز");
}

document.querySelectorAll("[data-snippet]").forEach(el=>{
  el.addEventListener("click", ()=>{
    const key = el.getAttribute("data-snippet");
    insertSnippet(key);
  });
});

/* =========================
   UI events (buttons)
========================= */
document.getElementById("btnRun").addEventListener("click", run);

document.getElementById("btnReset").addEventListener("click", ()=>{
  if(!confirm("أكيد تبي مسح كل شيء؟")) return;
  localStorage.removeItem(STORAGE_KEY);
  state = { html:"", css:"", js:"", assets:[] };
  setActiveTab("html");
  run();
  setStatus("تم مسح الكل");
});

document.getElementById("btnImportCode").addEventListener("click", ()=>{
  fileInputCode.value = "";
  fileInputCode.click();
});
fileInputCode.addEventListener("change", async (e)=>{
  const file = e.target.files?.[0];
  if(!file) return;
  await importCodeFile(file);
});

document.getElementById("btnAddAsset").addEventListener("click", ()=>{
  fileInputAsset.value = "";
  fileInputAsset.click();
});
fileInputAsset.addEventListener("change", async (e)=>{
  const files = e.target.files;
  if(!files || files.length === 0) return;
  await addAssetFiles(files);
});

document.getElementById("btnExportProject").addEventListener("click", exportProject);

document.getElementById("btnImportProject").addEventListener("click", ()=>{
  fileInputProject.value = "";
  fileInputProject.click();
});
fileInputProject.addEventListener("change", async (e)=>{
  const file = e.target.files?.[0];
  if(!file) return;
  await importProjectFile(file);
});

tabs.forEach(btn=>{
  btn.addEventListener("click", ()=> setActiveTab(btn.dataset.tab));
});

codeArea.addEventListener("input", ()=>{
  commitEditorToState();
  scheduleRun();
});
codeArea.addEventListener("blur", ()=> commitEditorToState());

/* =========================
   Keyboard Shortcuts
   - Ctrl+Enter: Run
   - Ctrl+S: Export project
   - Ctrl+O: Import code file
   - Ctrl+Shift+O: Add assets
   - F1: Help
   - Esc: Close help
========================= */
window.addEventListener("keydown", (e)=>{
  const key = (e.key || "").toLowerCase();

  // F1 help
  if(e.key === "F1"){
    e.preventDefault();
    openHelp();
    return;
  }

  // Esc close help
  if(e.key === "Escape" && helpBackdrop.classList.contains("open")){
    e.preventDefault();
    closeHelp();
    return;
  }

  // Ctrl shortcuts
  if(e.ctrlKey && !e.altKey){
    // Ctrl+Enter run
    if(e.key === "Enter"){
      e.preventDefault();
      run();
      return;
    }
    // Ctrl+S export project
    if(key === "s"){
      e.preventDefault();
      exportProject();
      return;
    }
    // Ctrl+O import code file
    if(key === "o" && !e.shiftKey){
      e.preventDefault();
      fileInputCode.value = "";
      fileInputCode.click();
      setStatus("اختر ملفًا للاستيراد");
      return;
    }
    // Ctrl+Shift+O add assets
    if(key === "o" && e.shiftKey){
      e.preventDefault();
      fileInputAsset.value = "";
      fileInputAsset.click();
      setStatus("اختر ملفات للمشروع");
      return;
    }
  }
});

/* =========================
   Init
========================= */
load();
setActiveTab("html");
run();
</script>
</body>
</html>
